name: ğŸ³ Publish Docker Images

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
    inputs:
      tag:
        description: 'è‡ªå®šä¹‰æ ‡ç­¾ (ä¾‹å¦‚: v1.2.3, latest, dev)'
        required: false
        default: ''

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ============================================
  # ä»£ç è´¨é‡æ£€æŸ¥
  # ============================================
  lint-and-test:
    name: ğŸ” ä»£ç æ£€æŸ¥ä¸æµ‹è¯•
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: ğŸ è®¾ç½® Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        cache: 'pip'
    
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-dev.txt
    
    - name: ğŸ§¹ ä»£ç æ ¼å¼åŒ–æ£€æŸ¥
      run: |
        black --check --diff .
    
    - name: ğŸ“ ä»£ç é£æ ¼æ£€æŸ¥
      run: |
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
    
    - name: ğŸ” ç±»å‹æ£€æŸ¥
      run: |
        mypy . --ignore-missing-imports
    
    - name: ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•
      run: |
        pytest tests/ -v --cov=. --cov-report=xml --cov-report=html
    
    - name: ğŸ“Š ä¸Šä¼ æµ‹è¯•è¦†ç›–ç‡
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella

  # ============================================
  # æ„å»ºå’Œå‘å¸ƒ Docker é•œåƒ
  # ============================================
  build-and-publish:
    name: ğŸ³ æ„å»ºå’Œå‘å¸ƒé•œåƒ
    runs-on: ubuntu-latest
    needs: lint-and-test
    if: github.event_name != 'pull_request'
    
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–æ‰€æœ‰å†å²è®°å½•ç”¨äºæ ‡ç­¾
    
    - name: ğŸ³ è®¾ç½® Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: ğŸ” ç™»å½•åˆ° GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ·ï¸ ç¡®å®šé•œåƒæ ‡ç­¾
      id: tags
      run: |
        # é»˜è®¤æ ‡ç­¾
        TAGS="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"
        
        # å¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘ä¸”æœ‰è‡ªå®šä¹‰æ ‡ç­¾
        if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ github.event.inputs.tag }}" ]]; then
          CUSTOM_TAG="${{ github.event.inputs.tag }}"
          echo "ä½¿ç”¨è‡ªå®šä¹‰æ ‡ç­¾: $CUSTOM_TAG"
          echo "tags=$TAGS:$CUSTOM_TAG" >> $GITHUB_OUTPUT
          echo "latest=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # å¦‚æœæ˜¯æ ‡ç­¾æ¨é€
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "æ£€æµ‹åˆ° Git æ ‡ç­¾: $TAG_NAME"
          
          # éªŒè¯æ ‡ç­¾æ ¼å¼
          if [[ $TAG_NAME =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9\.]+)?$ ]]; then
            echo "æ ‡ç­¾æ ¼å¼æœ‰æ•ˆ"
            
            # æå–ç‰ˆæœ¬å·
            VERSION=${TAG_NAME#v}
            MAJOR=$(echo $VERSION | cut -d. -f1)
            MINOR=$(echo $VERSION | cut -d. -f1-2)
            
            # æ„å»ºæ ‡ç­¾åˆ—è¡¨
            TAG_LIST="$TAG_NAME,$VERSION,$MAJOR.$MINOR,$MAJOR"
            
            # å¦‚æœæ˜¯ç¨³å®šç‰ˆæœ¬ï¼Œæ·»åŠ  latest
            if [[ ! $TAG_NAME =~ - ]]; then
              TAG_LIST="$TAG_LIST,latest"
              echo "latest=true" >> $GITHUB_OUTPUT
            else
              echo "latest=false" >> $GITHUB_OUTPUT
            fi
            
            echo "é•œåƒæ ‡ç­¾: $TAG_LIST"
            echo "tags=$TAG_LIST" >> $GITHUB_OUTPUT
            
          else
            echo "æ ‡ç­¾æ ¼å¼æ— æ•ˆï¼Œä½¿ç”¨æ ‡ç­¾åç§°"
            echo "tags=$TAG_NAME" >> $GITHUB_OUTPUT
            echo "latest=false" >> $GITHUB_OUTPUT
          fi
          
        # å¦‚æœæ˜¯ä¸»åˆ†æ”¯æ¨é€
        elif [[ "${{ github.ref }}" == refs/heads/main ]]; then
          echo "ä¸»åˆ†æ”¯æ¨é€ï¼Œä½¿ç”¨ latest å’Œ commit hash"
          SHORT_SHA=${GITHUB_SHA::8}
          echo "tags=latest,sha-$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "latest=true" >> $GITHUB_OUTPUT
          
        else
          echo "å…¶ä»–åˆ†æ”¯ï¼Œä½¿ç”¨åˆ†æ”¯åå’Œ commit hash"
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          BRANCH_NAME=${BRANCH_NAME//\//-}
          SHORT_SHA=${GITHUB_SHA::8}
          echo "tags=$BRANCH_NAME,sha-$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "latest=false" >> $GITHUB_OUTPUT
        fi
    
    - name: ğŸ·ï¸ æ„å»ºæ ‡ç­¾å­—ç¬¦ä¸²
      id: tag-string
      run: |
        TAGS="${{ steps.tags.outputs.tags }}"
        REGISTRY="${{ env.REGISTRY }}"
        IMAGE_NAME="${{ env.IMAGE_NAME }}"
        
        # å°†é€—å·åˆ†éš”çš„æ ‡ç­¾è½¬æ¢ä¸º Docker æ ‡ç­¾æ ¼å¼
        IFS=',' read -ra TAG_ARRAY <<< "$TAGS"
        TAG_STRING=""
        
        for TAG in "${TAG_ARRAY[@]}"; do
          TAG_STRING="$TAG_STRING $REGISTRY/$IMAGE_NAME:$TAG"
        done
        
        # å»é™¤é¦–å°¾ç©ºæ ¼
        TAG_STRING=$(echo $TAG_STRING | xargs)
        
        echo "æœ€ç»ˆæ ‡ç­¾å­—ç¬¦ä¸²: $TAG_STRING"
        echo "tag-string=$TAG_STRING" >> $GITHUB_OUTPUT
    
    - name: ğŸ³ æ„å»ºç”Ÿäº§é•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ steps.tag-string.outputs.tag-string }}
        labels: |
          org.opencontainers.image.title=CastMind
          org.opencontainers.image.description=æ’­å®¢æ™ºèƒ½å¤„ç†ç³»ç»Ÿ
          org.opencontainers.image.url=https://github.com/${{ github.repository }}
          org.opencontainers.image.source=https://github.com/${{ github.repository }}
          org.opencontainers.image.version=${{ github.ref_name }}
          org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
          org.opencontainers.image.revision=${{ github.sha }}
          org.opencontainers.image.licenses=MIT
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64,linux/arm64
        target: production
    
    - name: ğŸ³ æ„å»ºå¼€å‘é•œåƒï¼ˆå¯é€‰ï¼‰
      if: steps.tags.outputs.latest == 'true'
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:dev
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64,linux/arm64
        target: development
    
    - name: ğŸ“Š é•œåƒæ‰«æ
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH'
    
    - name: ğŸ“ ä¸Šä¼ å®‰å…¨æ‰«ææŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: security-scan-report
        path: trivy-results.sarif
        retention-days: 30
    
    - name: ğŸ“¦ ç”Ÿæˆ SBOMï¼ˆè½¯ä»¶ç‰©æ–™æ¸…å•ï¼‰
      uses: anchore/sbom-action@v0
      with:
        image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
        format: spdx-json
    
    - name: ğŸ“ ä¸Šä¼  SBOM
      uses: actions/upload-artifact@v4
      with:
        name: sbom-report
        path: sbom.spdx.json
        retention-days: 30
    
    - name: ğŸ“Š é•œåƒå¤§å°åˆ†æ
      run: |
        echo "ğŸ“¦ é•œåƒå¤§å°åˆ†æ:"
        docker images ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }} --format "table {{.Tag}}\t{{.Size}}"
    
    - name: ğŸ“ ç”Ÿæˆå‘å¸ƒè¯´æ˜
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        TAG_NAME=${GITHUB_REF#refs/tags/}
        
        # è·å–æœ€è¿‘çš„æäº¤ä¿¡æ¯
        git log --oneline -10 > recent_commits.txt
        
        echo "ğŸ‰ CastMind $TAG_NAME å‘å¸ƒ" > release_notes.md
        echo "" >> release_notes.md
        echo "**å‘å¸ƒæ—¶é—´:** $(date)" >> release_notes.md
        echo "**æäº¤å“ˆå¸Œ:** ${{ github.sha }}" >> release_notes.md
        echo "" >> release_notes.md
        echo "## ğŸ³ Docker é•œåƒ" >> release_notes.md
        echo "" >> release_notes.md
        echo "é•œåƒåœ°å€: \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}\`" >> release_notes.md
        echo "" >> release_notes.md
        echo "å¯ç”¨æ ‡ç­¾:" >> release_notes.md
        IFS=',' read -ra TAG_ARRAY <<< "${{ steps.tags.outputs.tags }}"
        for TAG in "${TAG_ARRAY[@]}"; do
          echo "- \`$TAG\`" >> release_notes.md
        done
        echo "" >> release_notes.md
        echo "## ğŸ“ æœ€è¿‘æäº¤" >> release_notes.md
        echo "" >> release_notes.md
        cat recent_commits.txt >> release_notes.md
        
        cat release_notes.md
    
    - name: ğŸš€ åˆ›å»º GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        name: CastMind ${{ github.ref_name }}
        body_path: release_notes.md
        draft: false
        prerelease: ${{ contains(github.ref_name, '-') }}
        files: |
          trivy-results.sarif
          sbom.spdx.json
    
    - name: ğŸ“§ å‘é€å‘å¸ƒé€šçŸ¥
      if: success() && startsWith(github.ref, 'refs/tags/')
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 465
        username: ${{ secrets.MAIL_USERNAME }}
        password: ${{ secrets.MAIL_PASSWORD }}
        subject: "ğŸš€ CastMind ${{ github.ref_name }} å‘å¸ƒ"
        to: ${{ secrets.NOTIFICATION_EMAIL }}
        from: CastMind Releases <releases@castmind.example.com>
        body: |
          ğŸ‰ CastMind ${{ github.ref_name }} å·²å‘å¸ƒï¼
          
          é•œåƒåœ°å€: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          
          æ ‡ç­¾:
          ${{ steps.tags.outputs.tags }}
          
          æŸ¥çœ‹å‘å¸ƒè¯¦æƒ…: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ github.ref_name }}
          
          å·¥ä½œæµè¿è¡Œ: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

  # ============================================
  # æ¸…ç†å·¥ä½œæµ
  # ============================================
  cleanup:
    name: ğŸ§¹ æ¸…ç†
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ğŸ“Š å·¥ä½œæµæ€»ç»“
      run: |
        echo "ğŸ¯ é•œåƒå‘å¸ƒå·¥ä½œæµæ‰§è¡Œå®Œæˆ"
        echo "çŠ¶æ€: ${{ job.status }}"
        echo "è§¦å‘äº‹ä»¶: ${{ github.event_name }}"
        echo "åˆ†æ”¯/æ ‡ç­¾: ${{ github.ref }}"
        echo "æäº¤: ${{ github.sha }}"
        echo "è¿è¡Œæ—¶é—´: ${{ job.steps.*.run_duration }}"
        echo "è¯¦ç»†ä¿¡æ¯: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"