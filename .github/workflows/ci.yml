name: ğŸ” CI - ä»£ç æ£€æŸ¥ä¸æµ‹è¯•

on:
  push:
    branches: [ main, develop, 'feature/**' ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # æ¯å‘¨ä¸€å‡Œæ™¨2ç‚¹è¿è¡Œ
    - cron: '0 2 * * 1'

jobs:
  # ============================================
  # ä»£ç è´¨é‡æ£€æŸ¥
  # ============================================
  code-quality:
    name: ğŸ” ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: ğŸ è®¾ç½® Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        cache: 'pip'
    
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-dev.txt
    
    - name: ğŸ§¹ ä»£ç æ ¼å¼åŒ–æ£€æŸ¥ (Black)
      run: |
        black --check --diff .
    
    - name: ğŸ“ ä»£ç é£æ ¼æ£€æŸ¥ (Flake8)
      run: |
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
    
    - name: ğŸ” ç±»å‹æ£€æŸ¥ (MyPy)
      run: |
        mypy . --ignore-missing-imports
    
    - name: ğŸ• å®‰å…¨æ£€æŸ¥ (Bandit)
      run: |
        bandit -r . -f json -o bandit-report.json || true
    
    - name: ğŸš¨ ä¾èµ–å®‰å…¨æ£€æŸ¥ (Safety)
      run: |
        safety check --full-report
    
    - name: ğŸ“Š ä»£ç å¤æ‚åº¦åˆ†æ
      run: |
        radon cc . -a -s -n B
    
    - name: ğŸ“ ä¸Šä¼ æ£€æŸ¥æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: code-quality-reports
        path: |
          bandit-report.json
        retention-days: 7

  # ============================================
  # å•å…ƒæµ‹è¯•
  # ============================================
  unit-tests:
    name: ğŸ§ª å•å…ƒæµ‹è¯•
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: ğŸ è®¾ç½® Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        cache: 'pip'
    
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-dev.txt
    
    - name: ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•
      run: |
        pytest tests/ -v --cov=. --cov-report=xml --cov-report=html --junitxml=test-results.xml
    
    - name: ğŸ“Š ä¸Šä¼ æµ‹è¯•è¦†ç›–ç‡
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
    
    - name: ğŸ“ ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-reports
        path: |
          htmlcov/
          test-results.xml
          coverage.xml
        retention-days: 7

  # ============================================
  # é›†æˆæµ‹è¯•ï¼ˆå¯é€‰ï¼‰
  # ============================================
  integration-tests:
    name: ğŸ”— é›†æˆæµ‹è¯•
    runs-on: ubuntu-latest
    needs: unit-tests
    
    services:
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: ğŸ è®¾ç½® Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        cache: 'pip'
    
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-dev.txt
    
    - name: ğŸ”§ è®¾ç½®æµ‹è¯•ç¯å¢ƒ
      run: |
        echo "REDIS_URL=redis://localhost:6379/0" >> $GITHUB_ENV
        echo "DATABASE_URL=sqlite:///test.db" >> $GITHUB_ENV
        echo "APP_ENV=testing" >> $GITHUB_ENV
    
    - name: ğŸ§ª è¿è¡Œé›†æˆæµ‹è¯•
      run: |
        # æ£€æŸ¥æ˜¯å¦æœ‰é›†æˆæµ‹è¯•ç›®å½•
        if [ -d "tests/integration" ]; then
          pytest tests/integration/ -v --tb=short --junitxml=integration-test-results.xml
        else
          echo "âš ï¸ æ²¡æœ‰æ‰¾åˆ°é›†æˆæµ‹è¯•ç›®å½•ï¼Œè·³è¿‡é›†æˆæµ‹è¯•"
        fi
    
    - name: ğŸ“ ä¸Šä¼ é›†æˆæµ‹è¯•æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: integration-test-reports
        path: integration-test-results.xml
        retention-days: 7

  # ============================================
  # Docker æ„å»ºæµ‹è¯•
  # ============================================
  docker-build-test:
    name: ğŸ³ Docker æ„å»ºæµ‹è¯•
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: ğŸ³ è®¾ç½® Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: ğŸ³ æµ‹è¯•æ„å»ºç”Ÿäº§é•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: .
        push: false
        tags: castmind:test
        cache-from: type=gha
        cache-to: type=gha,mode=max
        target: production
    
    - name: ğŸ³ æµ‹è¯•æ„å»ºå¼€å‘é•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: .
        push: false
        tags: castmind:dev-test
        cache-from: type=gha
        cache-to: type=gha,mode=max
        target: development
    
    - name: ğŸ“Š é•œåƒå¤§å°æ£€æŸ¥
      run: |
        echo "ğŸ“¦ é•œåƒå¤§å°:"
        docker images castmind --format "table {{.Tag}}\t{{.Size}}"
        
        # æ£€æŸ¥é•œåƒå¤§å°æ˜¯å¦åˆç†
        SIZE=$(docker images castmind:test --format "{{.Size}}" | sed 's/[^0-9.]//g')
        if (( $(echo "$SIZE > 1000" | bc -l) )); then
          echo "âš ï¸ è­¦å‘Š: é•œåƒå¤§å°è¶…è¿‡ 1GB ($SIZE MB)"
        else
          echo "âœ… é•œåƒå¤§å°æ­£å¸¸ ($SIZE MB)"
        fi

  # ============================================
  # å·¥ä½œæµæ€»ç»“
  # ============================================
  summary:
    name: ğŸ“Š å·¥ä½œæµæ€»ç»“
    runs-on: ubuntu-latest
    needs: [code-quality, unit-tests, integration-tests, docker-build-test]
    if: always()
    
    steps:
    - name: ğŸ“Š ç”Ÿæˆæ€»ç»“æŠ¥å‘Š
      run: |
        echo "# ğŸ¯ CI å·¥ä½œæµæ‰§è¡Œæ€»ç»“" > summary.md
        echo "" >> summary.md
        echo "**å·¥ä½œæµ:** ${{ github.workflow }}" >> summary.md
        echo "**è§¦å‘äº‹ä»¶:** ${{ github.event_name }}" >> summary.md
        echo "**åˆ†æ”¯:** ${{ github.ref }}" >> summary.md
        echo "**æäº¤:** ${{ github.sha }}" >> summary.md
        echo "**è¿è¡Œæ—¶é—´:** $(date)" >> summary.md
        echo "" >> summary.md
        echo "## ğŸ“ˆ ä½œä¸šçŠ¶æ€" >> summary.md
        echo "" >> summary.md
        echo "| ä½œä¸š | çŠ¶æ€ |" >> summary.md
        echo "|------|------|" >> summary.md
        echo "| ğŸ” ä»£ç è´¨é‡æ£€æŸ¥ | ${{ needs.code-quality.result }}" >> summary.md
        echo "| ğŸ§ª å•å…ƒæµ‹è¯• | ${{ needs.unit-tests.result }}" >> summary.md
        echo "| ğŸ”— é›†æˆæµ‹è¯• | ${{ needs.integration-tests.result }}" >> summary.md
        echo "| ğŸ³ Docker æ„å»ºæµ‹è¯• | ${{ needs.docker-build-test.result }}" >> summary.md
        echo "" >> summary.md
        echo "## ğŸ”— ç›¸å…³é“¾æ¥" >> summary.md
        echo "" >> summary.md
        echo "- å·¥ä½œæµè¿è¡Œ: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> summary.md
        echo "- ä»£ç ä»“åº“: ${{ github.server_url }}/${{ github.repository }}" >> summary.md
        echo "- æäº¤è¯¦æƒ…: ${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}" >> summary.md
        
        cat summary.md
    
    - name: ğŸ“§ å‘é€å¤±è´¥é€šçŸ¥
      if: failure()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 465
        username: ${{ secrets.MAIL_USERNAME }}
        password: ${{ secrets.MAIL_PASSWORD }}
        subject: "âŒ CastMind CI å¤±è´¥: ${{ github.ref }}"
        to: ${{ secrets.NOTIFICATION_EMAIL }}
        from: CastMind CI <ci@castmind.example.com>
        body: |
          âŒ CastMind CI å·¥ä½œæµå¤±è´¥ï¼
          
          å·¥ä½œæµ: ${{ github.workflow }}
          åˆ†æ”¯: ${{ github.ref }}
          æäº¤: ${{ github.sha }}
          æ—¶é—´: $(date)
          
          å¤±è´¥ä½œä¸š:
          ${{ toJSON(needs) }}
          
          æŸ¥çœ‹è¯¦æƒ…: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          è¯·æ£€æŸ¥ä»£ç å¹¶ä¿®å¤é—®é¢˜ã€‚