# ğŸ  CastMind NAS ä¸“ç”¨ Docker Compose é…ç½®
# ç‰ˆæœ¬: 1.0.0
# æè¿°: é’ˆå¯¹å®¶åº­ NAS æœåŠ¡å™¨ä¼˜åŒ–çš„è½»é‡çº§é…ç½®

version: '3.8'

# ç½‘ç»œé…ç½®ï¼ˆä½¿ç”¨ host æ¨¡å¼ç®€åŒ–ç½‘ç»œï¼‰
networks:
  castmind-nas:
    driver: bridge
    external: false

# æ•°æ®å·é…ç½®ï¼ˆæ˜ å°„åˆ° NAS å­˜å‚¨ï¼‰
volumes:
  castmind-data:
    driver: local
    driver_opts:
      type: none
      device: /volume1/docker/castmind/data  # ç¾¤æ™–è·¯å¾„
      # device: /share/CACHEDEV1_DATA/Container/castmind/data  # QNAP è·¯å¾„
      o: bind
  castmind-logs:
    driver: local
    driver_opts:
      type: none
      device: /volume1/docker/castmind/logs
      o: bind
  castmind-config:
    driver: local
    driver_opts:
      type: none
      device: /volume1/docker/castmind/config
      o: bind
  obsidian-vault:
    driver: local
    driver_opts:
      type: none
      device: /volume1/homes/your_user/Obsidian  # Obsidian ä»“åº“è·¯å¾„
      o: bind

# æœåŠ¡å®šä¹‰ï¼ˆç®€åŒ–ç‰ˆï¼Œé€‚åˆ NAS èµ„æºé™åˆ¶ï¼‰
services:
  # Redis æœåŠ¡ï¼ˆè½»é‡çº§æ¶ˆæ¯é˜Ÿåˆ—ï¼‰
  redis:
    image: redis:7-alpine
    container_name: castmind-nas-redis
    restart: unless-stopped
    command: >
      redis-server
      --appendonly yes
      --requirepass ${REDIS_PASSWORD:-nas123}
      --maxmemory 128mb
      --maxmemory-policy allkeys-lru
    networks:
      - castmind-nas
    volumes:
      - castmind-data:/data
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD:-nas123}
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-nas123}", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 64M

  # CastMind ä¸»æœåŠ¡ï¼ˆNAS ä¼˜åŒ–ç‰ˆï¼‰
  castmind:
    build:
      context: .
      target: production
    container_name: castmind-nas
    restart: unless-stopped
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - castmind-nas
    ports:
      - "${HOST_PORT:-8000}:8000"
    volumes:
      - castmind-data:/app/data
      - castmind-logs:/app/logs
      - castmind-config:/app/config
      - obsidian-vault:/obsidian:ro  # Obsidian é›†æˆ
    environment:
      # åº”ç”¨é…ç½®
      - APP_ENV=production
      - TZ=${TZ:-Asia/Shanghai}
      - LOG_LEVEL=INFO
      
      # æ•°æ®åº“é…ç½®ï¼ˆä½¿ç”¨ SQLite ç®€åŒ–éƒ¨ç½²ï¼‰
      - DATABASE_URL=sqlite:///data/castmind.db
      
      # Redis é…ç½®
      - REDIS_URL=redis://:${REDIS_PASSWORD:-nas123}@redis:6379/0
      
      # AI é…ç½®
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL:-https://api.deepseek.com}
      - DEFAULT_AI_MODEL=${DEFAULT_AI_MODEL:-deepseek-chat}
      
      # Obsidian é›†æˆé…ç½®
      - OBSIDIAN_VAULT=/obsidian
      - OBSIDIAN_PODCASTS_DIR=/obsidian/Podcasts/CastMind
      
      # NAS ä¸“ç”¨é…ç½®
      - PROCESS_BATCH_SIZE=3  # å‡å°‘æ‰¹é‡å¤§å°
      - MAX_RETRIES=2         # å‡å°‘é‡è¯•æ¬¡æ•°
      - RETRY_DELAY=120       # å¢åŠ é‡è¯•å»¶è¿Ÿ
      
      # èµ„æºé™åˆ¶
      - MEMORY_LIMIT=512      # å†…å­˜é™åˆ¶ 512MB
      - CPU_LIMIT=1           # CPU é™åˆ¶ 1 æ ¸å¿ƒ
      
      # å¤‡ä»½é…ç½®
      - BACKUP_DIR=/app/data/backups
      - BACKUP_RETENTION_DAYS=7
      - BACKUP_SCHEDULE="0 3 * * *"  # æ¯å¤©å‡Œæ™¨3ç‚¹
    healthcheck:
      test: ["CMD", "python", "-c", "import sqlite3; conn = sqlite3.connect('/app/data/castmind.db'); conn.execute('SELECT 1'); conn.close()"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 90s
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.5'
    # å®‰å…¨é…ç½®
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:size=64M,mode=1777

  # å®šæ—¶ä»»åŠ¡æœåŠ¡ï¼ˆç®€åŒ–ç‰ˆï¼‰
  castmind-scheduler:
    image: alpine:latest
    container_name: castmind-nas-scheduler
    restart: unless-stopped
    depends_on:
      - castmind
    networks:
      - castmind-nas
    volumes:
      - castmind-config:/config:ro
    command: >
      sh -c "
      echo 'ğŸš€ CastMind NAS å®šæ—¶ä»»åŠ¡æœåŠ¡å¯åŠ¨' &&
      echo 'å®šæ—¶ä»»åŠ¡é…ç½®:' &&
      echo '  æ¯30åˆ†é’Ÿ: å¤„ç†æ’­å®¢' &&
      echo '  æ¯å¤©03:00: æ•°æ®å¤‡ä»½' &&
      echo '  æ¯å‘¨ä¸€03:00: æ¸…ç†æ—§æ–‡ä»¶' &&
      
      # å®‰è£… curl
      apk add --no-cache curl &&
      
      # ä¸»å¾ªç¯
      while true; do
        # æ¯30åˆ†é’Ÿå¤„ç†æ’­å®¢
        if [ $$(date +%M) = '00' ] || [ $$(date +%M) = '30' ]; then
          echo 'â° æ‰§è¡Œæ’­å®¢å¤„ç†ä»»åŠ¡: $$(date)' &&
          curl -X POST http://castmind:8000/api/v1/tasks/process-podcasts || true
        fi
        
        # æ¯å¤©å‡Œæ™¨3ç‚¹å¤‡ä»½
        if [ $$(date +%H:%M) = '03:00' ]; then
          echo 'ğŸ’¾ æ‰§è¡Œæ•°æ®å¤‡ä»½: $$(date)' &&
          curl -X POST http://castmind:8000/api/v1/backup || true
        fi
        
        # æ¯å‘¨ä¸€å‡Œæ™¨3ç‚¹æ¸…ç†
        if [ $$(date +%u) -eq 1 ] && [ $$(date +%H:%M) = '03:00' ]; then
          echo 'ğŸ§¹ æ‰§è¡Œæ¸…ç†ä»»åŠ¡: $$(date)' &&
          curl -X POST http://castmind:8000/api/v1/cleanup || true
        fi
        
        # ç­‰å¾…1åˆ†é’Ÿ
        sleep 60
      done
      "
    deploy:
      resources:
        limits:
          memory: 64M
        reservations:
          memory: 32M

  # ç›‘æ§é¢æ¿ï¼ˆè½»é‡çº§ï¼‰
  castmind-monitor:
    image: nginx:alpine
    container_name: castmind-nas-monitor
    restart: unless-stopped
    depends_on:
      - castmind
    networks:
      - castmind-nas
    ports:
      - "${MONITOR_PORT:-8080}:80"
    volumes:
      - ./monitoring/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./monitoring/html:/usr/share/nginx/html:ro
    environment:
      - NGINX_HOST=castmind-nas-monitor
      - NGINX_PORT=80
    deploy:
      resources:
        limits:
          memory: 64M
        reservations:
          memory: 32M

# è‡ªå®šä¹‰ç½‘ç»œé…ç½®
networks:
  castmind-nas:
    driver: bridge
    ipam:
      config:
        - subnet: 172.22.0.0/16
          gateway: 172.22.0.1